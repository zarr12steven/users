---
 - name: Create group
   group:
     name: "{{ item }}"
     guid: "{{ item.guid | default(omit) }}"
     state: "{{ item.state | default('present') }}"
     system: "{{ item.system | default(False) }}"
   with_items: "{{ management_groups }}"

 - name: Create Normal User
   user:
     name: "{{ item }}"
     uid: "{{ management_active_users[item].uid | default(omit) }}"
     password: "{{ management_active_users[item].password | default('!!') }}"
     comment: "{{ management_active_users[item].full_name | default('') }}"
     createhome: "{{ management_active_users[item].createhome | default('yes') }}"
     group: "{{ management_active_users[item].group | default(omit) }}"
     groups: "{{ management_active_users[item].groups | default('') | join(',') }}"
     shell: "{{ management_active_users[item].shell | default('/bin/bash') }}"
     append: "{{ management_active_users[item].append | default('no') }}"
     state: "{{ management_active_users[item].state | default('present') }}"
   with_items: "{{ management_active_users }}"
   when: management_active_users is defined

 - name: Setup authorized key
   authorized_key:
     user: "{{ item }}"
     key: "{{ lookup('file', 'public_key_path' ~ management_active_users[item].public_key ) }}"
   with_items: "{{ management_active_users }}"
   when: management_active_users[item].public_key is defined

 - name: Remove active user authorized key
   authorized_key:
     user: "{{ item }}"
     key: "{{ lookup('file', 'publice_key_path' ~ management_active_users[item].remove_public_key ) }}"
     state: absent
   with_items: "{{ management_active_users }}"
   when: management_active_users[item].remove_public_key is defined

 - name: Remove Normal User
   user:
     name: "{{ item }}"
     remove: "{{ item.remove | default('yes') }}"
     state: "{{ item.state | default('absent') }}"
   with_items: "{{ management_remove_users }}"
   when: management_remove_users is defined
